let STATE_PLAINTEXT=Symbol('plaintext'),STATE_HTML=Symbol('html'),STATE_COMMENT=Symbol('comment');function striptags(html=''){if('string'!=typeof html&&!(html instanceof String))return'';let state=STATE_PLAINTEXT,tag_buffer='',depth=0,in_quote_char='',output='';var length=html.length;for(let idx=0;idx<length;idx++){var char=html[idx];if(state===STATE_PLAINTEXT)'<'===char?(state=STATE_HTML,tag_buffer+=char):output+=char;else if(state===STATE_HTML)switch(char){case'<':in_quote_char||depth++;break;case'>':in_quote_char||(depth?depth--:(in_quote_char='',state=STATE_PLAINTEXT,tag_buffer=''));break;case'"':case'\'':in_quote_char=char===in_quote_char?'':in_quote_char||char,tag_buffer+=char;break;case'-':'<!-'===tag_buffer&&(state=STATE_COMMENT),tag_buffer+=char;break;case' ':case'\n':'<'===tag_buffer?(state=STATE_PLAINTEXT,output+='< ',tag_buffer=''):tag_buffer+=char;break;default:tag_buffer+=char}else state===STATE_COMMENT&&('>'===char?('--'===tag_buffer.slice(-2)&&(state=STATE_PLAINTEXT),tag_buffer=''):tag_buffer+=char)}return output}class LocalSearch{constructor({path='',unescape=!1,top_n_per_article=1}){this.path=path,this.unescape=unescape,this.top_n_per_article=top_n_per_article,this.isfetched=!1,this.datas=null}getIndexByWord(words,text,caseSensitive=!1){let index=[],included=new Set;return caseSensitive||(text=text.toLowerCase()),words.forEach(word=>{this.unescape&&((div=document.createElement('div')).innerText=word,word=div.innerHTML);var div,wordLen=word.length;if(0!==wordLen){let startPosition=0;var position;for(caseSensitive||(word=word.toLowerCase());-1<(position=text.indexOf(word,startPosition));)index.push({position:position,word:word}),included.add(word),startPosition=position+wordLen}}),index.sort((left,right)=>left.position!==right.position?left.position-right.position:right.word.length-left.word.length),[index,included]}mergeIntoSlice(start,end,index){var item;let{position,word}=index[0];for(var hits=[],count=new Set;position+word.length<=end&&0!==index.length;){count.add(word),hits.push({position:position,length:word.length});var wordEnd=position+word.length;for(index.shift();0!==index.length&&(item=index[0],position=item.position,word=item.word,wordEnd>position);)index.shift()}return{hits:hits,start:start,end:end,count:count.size}}highlightKeyword(val,slice){let result='',index=slice.start;for(var{position,length}of slice.hits)result+=val.substring(index,position),index=position+length,result+=`<mark class="search-keyword">${val.substr(position,length)}</mark>`;return result+=val.substring(index,slice.end)}getResultItems(keywords){let resultItems=[];return this.datas.forEach(({title,content,url})=>{var[indexOfTitle,keysOfTitle]=this.getIndexByWord(keywords,title),[indexOfContent,keysOfContent]=this.getIndexByWord(keywords,content),keysOfTitle=new Set([...keysOfTitle,...keysOfContent]).size,keysOfContent=indexOfTitle.length+indexOfContent.length;if(0!==keysOfContent){var slicesOfTitle=[];0!==indexOfTitle.length&&slicesOfTitle.push(this.mergeIntoSlice(0,title.length,indexOfTitle));let slicesOfContent=[];for(;0!==indexOfContent.length;){var position=indexOfContent[0].position,start=Math.max(0,position-20),position=Math.min(content.length,position+80);slicesOfContent.push(this.mergeIntoSlice(start,position,indexOfContent))}slicesOfContent.sort((left,right)=>left.count!==right.count?right.count-left.count:left.hits.length!==right.hits.length?right.hits.length-left.hits.length:left.start-right.start);indexOfTitle=parseInt(this.top_n_per_article,10);0<=indexOfTitle&&(slicesOfContent=slicesOfContent.slice(0,indexOfTitle));let resultItem='';(url=new URL(url,location.origin)).searchParams.append('highlight',keywords.join(' ')),resultItem+=0!==slicesOfTitle.length?`<li><a href="${url.href}" class="search-result-title">${this.highlightKeyword(title,slicesOfTitle[0])}</a>`:`<li><a href="${url.href}" class="search-result-title">${title}</a>`,slicesOfContent.forEach(slice=>{resultItem+=`<a href="${url.href}"><p class="search-result">${this.highlightKeyword(content,slice)}...</p></a>`}),resultItem+='</li>',resultItems.push({item:resultItem,id:resultItems.length,hitCount:keysOfContent,includedCount:keysOfTitle})}}),resultItems}fetchData(){let isXml=!this.path.endsWith('json');fetch(this.path).then(response=>response.text()).then(res=>{this.isfetched=!0,this.datas=isXml?[...(new DOMParser).parseFromString(res,'text/xml').querySelectorAll('entry')].map(element=>({title:element.querySelector('title').textContent,content:element.querySelector('content').textContent,url:element.querySelector('url').textContent})):JSON.parse(res),this.datas=this.datas.filter(data=>data.title).map(data=>(data.title=data.title.trim(),data.content=data.content?striptags(data.content.trim()):'',data.url=decodeURIComponent(data.url).replace(/\/{2,}/g,'/'),data)),window.dispatchEvent(new Event('search:loaded'))})}highlightText(node,slice,className){var val=node.nodeValue;let index=slice.start;var position,length,children=[];for({position,length}of slice.hits){var text=document.createTextNode(val.substring(index,position)),mark=(index=position+length,document.createElement('mark'));mark.className=className,mark.appendChild(document.createTextNode(val.substr(position,length))),children.push(text,mark)}node.nodeValue=val.substring(index,slice.end),children.forEach(element=>{node.parentNode.insertBefore(element,node)})}highlightSearchWords(body){var params=new URL(location.href).searchParams.get('highlight');let keywords=params?params.split(' '):[];if(keywords.length&&body){for(var walk=document.createTreeWalker(body,NodeFilter.SHOW_TEXT,null),allNodes=[];walk.nextNode();)walk.currentNode.parentNode.matches('button, select, textarea, .mermaid')||allNodes.push(walk.currentNode);allNodes.forEach(node=>{var[indexOfNode]=this.getIndexByWord(keywords,node.nodeValue);indexOfNode.length&&(indexOfNode=this.mergeIntoSlice(0,node.nodeValue.length,indexOfNode),this.highlightText(node,indexOfNode,'search-keyword'))})}}}