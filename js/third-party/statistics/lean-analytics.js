class LeanCloudCounter{constructor(appId,appKey,apiServer){this.appId=appId,this.appKey=appKey,this.apiServer=apiServer}leancloudSelector(url){return url=encodeURI(url),document.getElementById(url).querySelector('.leancloud-visitors-count')}async request(method,url,data){return fetch(this.apiServer+'/1.1'+url,{method:method,headers:{'X-LC-Id':this.appId,'X-LC-Key':this.appKey,'Content-Type':'application/json'},body:JSON.stringify(data)})}async addCount(){var visitors=document.querySelector('.leancloud_visitors'),url=decodeURI(visitors.id),visitors=visitors.dataset.flagTitle;try{var results=(await(await this.request('get','/classes/Counter?where='+encodeURIComponent(JSON.stringify({url:url})))).json()).results;if(0<results.length){var counter=results[0];this.leancloudSelector(url).innerText=counter.time+1;try{await this.request('put','/classes/Counter/'+counter.objectId,{time:{__op:'Increment',amount:1}})}catch(error){console.error('Failed to save visitor count',error)}}else if(CONFIG.leancloud_visitors.security)this.leancloudSelector(url).innerText='Counter not initialized! More info at console err msg.',console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');else try{let response=await this.request('post','/classes/Counter',{title:visitors,url:url,time:1});await response.json(),this.leancloudSelector(url).innerText=1}catch(error){console.error('Failed to create',error)}}catch(error){console.error('LeanCloud Counter Error',error)}}async showTime(){var entries=[...document.querySelectorAll('.leancloud_visitors')].map(element=>decodeURI(element.id));try{var results=(await(await this.request('get','/classes/Counter?where='+encodeURIComponent(JSON.stringify({url:{$in:entries}})))).json()).results;for(let url of entries){var target=results.find(item=>item.url===url);this.leancloudSelector(url).innerText=target?target.time:0}}catch(error){console.error('LeanCloud Counter Error',error)}}}(()=>{let{app_id,app_key,server_url}=CONFIG.leancloud_visitors,fetchData=api_server=>{api_server=new LeanCloudCounter(app_id,app_key,api_server);CONFIG.page.isPost?CONFIG.hostname===location.hostname&&api_server.addCount():1<=document.querySelectorAll('.post-title-link').length&&api_server.showTime()},api_server;server_url?api_server=server_url:'-MdYXbMMI'===app_id.slice(-9)&&(api_server=`https://${app_id.slice(0,8).toLowerCase()}.api.lncldglobal.com`),document.addEventListener('page:loaded',async()=>{if(api_server)fetchData(api_server);else try{let api_server=(await(await fetch('https://app-router.leancloud.cn/2/route?appId='+app_id)).json()).api_server;fetchData('https://'+api_server)}catch(error){console.error('Failed to fetch API server',error)}})})();